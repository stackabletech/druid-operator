---
role: Aggregator
service:
  ports:
  - name: api
    port: 8686
    protocol: TCP
    targetPort: 8686
  - name: vector
    port: 6123
    protocol: TCP
    targetPort: 6000
customConfig:
  api:
    address: 0.0.0.0:8686
    enabled: true
  sources:
    vector:
      address: 0.0.0.0:6000
      type: vector
      version: "2"
  transforms:
    validEvents:
      type: filter
      inputs: [vector]
      condition: is_null(.errors)
    filteredAutomaticLogConfigBrokerDruid:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-broker-automatic-log-config-0" &&
        .container == "druid"
    filteredAutomaticLogConfigBrokerPrepare:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-broker-automatic-log-config-0" &&
        .container == "prepare"
    filteredAutomaticLogConfigBrokerVector:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-broker-automatic-log-config-0" &&
        .container == "vector"
    filteredCustomLogConfigBrokerDruid:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-broker-custom-log-config-0" &&
        .container == "druid"
    filteredCustomLogConfigBrokerPrepare:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-broker-custom-log-config-0" &&
        .container == "prepare"
    filteredCustomLogConfigBrokerVector:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-broker-custom-log-config-0" &&
        .container == "vector"
    filteredAutomaticLogConfigCoordinatorDruid:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-coordinator-automatic-log-config-0" &&
        .container == "druid"
    filteredAutomaticLogConfigCoordinatorPrepare:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-coordinator-automatic-log-config-0" &&
        .container == "prepare"
    filteredAutomaticLogConfigCoordinatorVector:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-coordinator-automatic-log-config-0" &&
        .container == "vector"
    filteredCustomLogConfigCoordinatorDruid:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-coordinator-custom-log-config-0" &&
        .container == "druid"
    filteredCustomLogConfigCoordinatorPrepare:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-coordinator-custom-log-config-0" &&
        .container == "prepare"
    filteredCustomLogConfigCoordinatorVector:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-coordinator-custom-log-config-0" &&
        .container == "vector"
    filteredAutomaticLogConfigHistoricalDruid:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-historical-automatic-log-config-0" &&
        .container == "druid"
    filteredAutomaticLogConfigHistoricalPrepare:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-historical-automatic-log-config-0" &&
        .container == "prepare"
    filteredAutomaticLogConfigHistoricalVector:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-historical-automatic-log-config-0" &&
        .container == "vector"
    filteredCustomLogConfigHistoricalDruid:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-historical-custom-log-config-0" &&
        .container == "druid"
    filteredCustomLogConfigHistoricalPrepare:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-historical-custom-log-config-0" &&
        .container == "prepare"
    filteredCustomLogConfigHistoricalVector:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-historical-custom-log-config-0" &&
        .container == "vector"
    filteredAutomaticLogConfigMiddlemanagerDruid:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-middlemanager-automatic-log-config-0" &&
        .container == "druid"
    filteredAutomaticLogConfigMiddlemanagerPrepare:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-middlemanager-automatic-log-config-0" &&
        .container == "prepare"
    filteredAutomaticLogConfigMiddlemanagerVector:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-middlemanager-automatic-log-config-0" &&
        .container == "vector"
    filteredCustomLogConfigMiddlemanagerDruid:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-middlemanager-custom-log-config-0" &&
        .container == "druid"
    filteredCustomLogConfigMiddlemanagerPrepare:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-middlemanager-custom-log-config-0" &&
        .container == "prepare"
    filteredCustomLogConfigMiddlemanagerVector:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-middlemanager-custom-log-config-0" &&
        .container == "vector"
    filteredAutomaticLogConfigRouterDruid:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-router-automatic-log-config-0" &&
        .container == "druid"
    filteredAutomaticLogConfigRouterPrepare:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-router-automatic-log-config-0" &&
        .container == "prepare"
    filteredAutomaticLogConfigRouterVector:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-router-automatic-log-config-0" &&
        .container == "vector"
    filteredCustomLogConfigRouterDruid:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-router-custom-log-config-0" &&
        .container == "druid"
    filteredCustomLogConfigRouterPrepare:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-router-custom-log-config-0" &&
        .container == "prepare"
    filteredCustomLogConfigRouterVector:
      type: filter
      inputs: [validEvents]
      condition: >-
        .pod == "test-druid-router-custom-log-config-0" &&
        .container == "vector"
    filteredInvalidEvents:
      type: filter
      inputs: [vector]
      condition: |-
        .timestamp == from_unix_timestamp!(0) ||
        is_null(.level) ||
        is_null(.logger) ||
        is_null(.message)
  sinks:
    test:
      inputs: [filtered*]
      type: blackhole
{% if lookup('env', 'VECTOR_AGGREGATOR') %}
    aggregator:
      inputs: [vector]
      type: vector
      address: {{ lookup('env', 'VECTOR_AGGREGATOR') }}
      buffer:
        # Avoid back pressure from VECTOR_AGGREGATOR. The test should
        # not fail if the aggregator is not available.
        when_full: drop_newest
{% endif %}
